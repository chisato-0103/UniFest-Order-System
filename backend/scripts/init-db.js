#!/usr/bin/env node
/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * Renderã®PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™
 */

const { Pool } = require("pg");
const fs = require("fs");
const path = require("path");
require("dotenv").config();

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®š
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl:
    process.env.NODE_ENV === "production"
      ? { rejectUnauthorized: false }
      : false,
});

async function initializeDatabase() {
  let client;

  try {
    console.log("ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...");
    client = await pool.connect();
    console.log("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ");

    // SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
    const schemaPath = path.join(__dirname, "../src/database/schema.sql");
    const schemaSql = fs.readFileSync(schemaPath, "utf8");

    console.log("ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆä¸­...");

    // ã‚¹ã‚­ãƒ¼ãƒã‚’å®Ÿè¡Œï¼ˆè¤‡æ•°ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’åˆ†å‰²ã—ã¦å®Ÿè¡Œï¼‰
    const statements = schemaSql
      .split(";")
      .map((stmt) => stmt.trim())
      .filter((stmt) => stmt.length > 0 && !stmt.startsWith("--"));

    for (const statement of statements) {
      if (statement.trim()) {
        try {
          await client.query(statement);
        } catch (error) {
          // æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
          if (
            error.code === "42P07" ||
            error.code === "42P06" ||
            error.code === "42P16"
          ) {
            console.log(`âš ï¸  ã‚¹ã‚­ãƒƒãƒ—: ${error.message}`);
          } else {
            console.error(
              `âŒ SQLå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${statement.substring(0, 100)}...`
            );
            console.error(error.message);
          }
        }
      }
    }

    console.log("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒä½œæˆå®Œäº†");

    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’ç¢ºèª
    const tablesResult = await client.query(`
      SELECT table_name
      FROM information_schema.tables
      WHERE table_schema = 'public'
      ORDER BY table_name;
    `);

    console.log("\nğŸ“‹ ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«:");
    tablesResult.rows.forEach((row) => {
      console.log(`  - ${row.table_name}`);
    });

    // ordersãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª
    const ordersCheck = await client.query(`
      SELECT EXISTS (
        SELECT FROM information_schema.tables
        WHERE table_schema = 'public'
        AND table_name = 'orders'
      );
    `);

    if (ordersCheck.rows[0].exists) {
      console.log("âœ… ordersãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ");
    } else {
      console.log("âŒ ordersãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  } catch (error) {
    console.error("âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
    process.exit(1);
  } finally {
    if (client) {
      client.release();
    }
    await pool.end();
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
if (require.main === module) {
  initializeDatabase()
    .then(() => {
      console.log("ğŸ‰ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ");
      process.exit(0);
    })
    .catch((error) => {
      console.error("ğŸ’¥ åˆæœŸåŒ–å¤±æ•—:", error);
      process.exit(1);
    });
}

module.exports = { initializeDatabase };
